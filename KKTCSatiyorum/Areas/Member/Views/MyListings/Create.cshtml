@model KKTCSatiyorum.Areas.Member.Models.MyListings.CreateIlanViewModel
@{
    ViewData["Title"] = "Yeni İlan Oluştur";
    Layout = "~/Areas/Member/Views/Shared/_MemberLayout.cshtml";
    
    
    var hasGeneralError = ViewData.ModelState.ContainsKey(string.Empty) && ViewData.ModelState[string.Empty]?.Errors.Count > 0;
    var hasPhotosError = ViewData.ModelState.ContainsKey("photos") && ViewData.ModelState["photos"]?.Errors.Count > 0;
    var hasSehirError = ViewData.ModelState.ContainsKey("Sehir") && ViewData.ModelState["Sehir"]?.Errors.Count > 0;
    var hasAttributesError = false;
    foreach (var key in ViewData.ModelState.Keys) { if (key.StartsWith("Attributes")) { hasAttributesError = true; break; } }
    var hasStep2Error = (ViewData.ModelState.ContainsKey("Baslik") && ViewData.ModelState["Baslik"]?.Errors.Count > 0) ||
                        (ViewData.ModelState.ContainsKey("Fiyat") && ViewData.ModelState["Fiyat"]?.Errors.Count > 0) ||
                        (ViewData.ModelState.ContainsKey("ParaBirimi") && ViewData.ModelState["ParaBirimi"]?.Errors.Count > 0) ||
                        hasAttributesError;
    
    int initialStep;
    if (hasGeneralError) { initialStep = 5; }
    else if (hasPhotosError) { initialStep = 3; }
    else if (hasSehirError) { initialStep = 4; }
    else if (hasStep2Error) { initialStep = 2; }
    else { initialStep = Model.KategoriId > 0 ? 2 : 1; }
}

<main class="py-4">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="d-flex justify-content-end mb-3">
                    <a asp-area="Member" asp-controller="MyListings" asp-action="Index" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-x-lg"></i> İptal
                    </a>
                </div>
                <h1 class="h2 text-center mb-4">Yeni İlan Oluştur</h1>

                <form asp-area="Member" asp-controller="MyListings" asp-action="Create" method="post" enctype="multipart/form-data" novalidate>
                    @Html.AntiForgeryToken()

                    @if (hasGeneralError)
                    {
                        <div class="alert alert-danger mb-4">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>İlan oluşturulamadı:</strong>
                            <ul class="mb-0 mt-2">
                                @foreach (var error in ViewData.ModelState[string.Empty]!.Errors)
                                {
                                    <li>@error.ErrorMessage</li>
                                }
                            </ul>
                        </div>
                    }

                    <div class="wizard-steps mb-4">
                        <div class="wizard-step@(initialStep > 1 ? " completed" : initialStep == 1 ? " active" : "")" data-step="1">
                            <div class="step-number">
                                @if (initialStep > 1)
                                {
                                    <i class="bi bi-check"></i>
                                }
                                else
                                {
                                    @:1
                                }
                            </div>
                            <span class="step-label">Kategori</span>
                        </div>
                        <div class="wizard-step@(initialStep > 2 ? " completed" : initialStep == 2 ? " active" : "")" data-step="2">
                            <div class="step-number">
                                @if (initialStep > 2)
                                {
                                    <i class="bi bi-check"></i>
                                }
                                else
                                {
                                    @:2
                                }
                            </div>
                            <span class="step-label">Detaylar</span>
                        </div>
                        <div class="wizard-step@(initialStep > 3 ? " completed" : initialStep == 3 ? " active" : "")" data-step="3">
                            <div class="step-number">
                                @if (initialStep > 3)
                                {
                                    <i class="bi bi-check"></i>
                                }
                                else
                                {
                                    @:3
                                }
                            </div>
                            <span class="step-label">Fotoğraf</span>
                        </div>
                        <div class="wizard-step@(initialStep > 4 ? " completed" : initialStep == 4 ? " active" : "")" data-step="4">
                            <div class="step-number">
                                @if (initialStep > 4)
                                {
                                    <i class="bi bi-check"></i>
                                }
                                else
                                {
                                    @:4
                                }
                            </div>
                            <span class="step-label">Konum</span>
                        </div>
                        <div class="wizard-step@(initialStep == 5 ? " active" : "")" data-step="5">
                            <div class="step-number">5</div>
                            <span class="step-label">Önizleme</span>
                        </div>
                    </div>

                    <div class="card mb-4 step-content" id="step1" style="display: @(initialStep == 1 ? "block" : "none");">
                        <div class="card-body p-4">
                            <h4 class="mb-4">Kategori Seçin</h4>
                            <div class="row g-3">
                                @foreach (var option in Model.KategoriOptions)
                                {
                                    if (string.IsNullOrEmpty(option.Value))
                                    {
                                        continue;
                                    }
                                    <div class="col-6 col-md-4">
                                        <div class="category-card" data-value="@option.Value" onclick="selectCategory(this)">
                                            <i class="bi bi-tag"></i>
                                            <div class="category-name">@option.Text</div>
                                        </div>
                                    </div>
                                }
                            </div>
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-primary" onclick="goToStep(2)">Devam Et <i class="bi bi-arrow-right ms-1"></i></button>
                            </div>
                            <select asp-for="KategoriId" asp-items="Model.KategoriOptions" class="form-select d-none" id="kategoriSelect"></select>
                            <span asp-validation-for="KategoriId" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="card mb-4 step-content" id="step2" style="display: @(initialStep == 2 ? "block" : "none");">
                        <div class="card-body p-4">
                            <h4 class="mb-4">İlan Detayları</h4>
                            <p class="text-muted mb-4"><span class="badge bg-primary me-2">Kategori</span>Seçilen kategori için detayları doldurun.</p>

                            <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-3"></div>

                            <h6 class="text-primary mb-3"><i class="bi bi-info-circle me-2"></i>Genel Bilgiler</h6>
                            <div class="mb-3">
                                <label asp-for="Baslik" class="form-label">İlan Başlığı *</label>
                                <input asp-for="Baslik" class="form-control" />
                                <span asp-validation-for="Baslik" class="text-danger small"></span>
                            </div>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label asp-for="Fiyat" class="form-label">Fiyat *</label>
                                    <div class="input-group">
                                        <input asp-for="Fiyat" type="number" step="0.01" min="0" class="form-control" />
                                        <span class="input-group-text">₺</span>
                                    </div>
                                    <span asp-validation-for="Fiyat" class="text-danger small"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="ParaBirimi" class="form-label">Para Birimi</label>
                                    <select asp-for="ParaBirimi" asp-items="Model.ParaBirimiOptions" class="form-select"></select>
                                </div>
                            </div>

                            <h6 class="text-primary mb-3"><i class="bi bi-list-ul me-2"></i>Kategori Özellikleri</h6>
                            <div id="dynamicAttributesContainer" class="mb-4" style="display:none;">
                                <div id="attributeFields" class="row g-3"></div>
                            </div>

                            <h6 class="text-primary mb-3"><i class="bi bi-text-paragraph me-2"></i>Açıklama</h6>
                            <textarea asp-for="Aciklama" class="form-control mb-2" rows="4"></textarea>
                            <span asp-validation-for="Aciklama" class="text-danger small"></span>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" onclick="goToStep(1)"><i class="bi bi-arrow-left me-1"></i> Geri</button>
                                <button type="button" class="btn btn-primary" onclick="goToStep(3)">Devam Et <i class="bi bi-arrow-right ms-1"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4 step-content" id="step3" style="display: @(initialStep == 3 ? "block" : "none");">
                        <div class="card-body p-4">
                            <h4 class="mb-4">Fotoğraf Ekle</h4>
                            @if (hasPhotosError)
                            {
                                <div class="alert alert-danger mb-3">
                                    <i class="bi bi-exclamation-circle me-2"></i>
                                    @ViewData.ModelState["photos"]!.Errors.FirstOrDefault()?.ErrorMessage
                                </div>
                            }
                            <div class="upload-zone mb-4">
                                <i class="bi bi-cloud-arrow-up"></i>
                                <p><strong>Fotoğrafları buraya sürükleyin</strong></p>
                                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('photoInput').click();"><i class="bi bi-folder me-2"></i>Dosya Seç</button>
                                <input type="file" name="photos" class="form-control d-none" multiple accept="image/*" id="photoInput" />
                            </div>
                            <small class="text-muted">PNG, JPG, WEBP formatında, max 5MB</small>
                            <div id="photoPreview" class="row mt-3"></div>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" onclick="goToStep(2)"><i class="bi bi-arrow-left me-1"></i> Geri</button>
                                <button type="button" class="btn btn-primary" onclick="goToStep(4)">Devam Et <i class="bi bi-arrow-right ms-1"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4 step-content" id="step4" style="display: @(initialStep == 4 ? "block" : "none");">
                        <div class="card-body p-4">
                            <h4 class="mb-4">Konum Belirle</h4>
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <label asp-for="Sehir" class="form-label">İl *</label>
                                    <input asp-for="Sehir" class="form-control" />
                                    <span asp-validation-for="Sehir" class="text-danger small"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="Ilce" class="form-label">İlçe</label>
                                    <input asp-for="Ilce" class="form-control" />
                                    <span asp-validation-for="Ilce" class="text-danger small"></span>
                                </div>
                            </div>
                            <input type="hidden" asp-for="Enlem" id="enlemInput" />
                            <input type="hidden" asp-for="Boylam" id="boylamInput" />
                            <div id="locationMap" class="map-container mb-3"></div>
                            <button type="button" class="btn btn-outline-primary mb-3" id="findMyLocationBtn"><i class="bi bi-geo me-2"></i>Konumumu Bul</button>
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" onclick="goToStep(3)"><i class="bi bi-arrow-left me-1"></i> Geri</button>
                                <button type="button" class="btn btn-primary" onclick="goToStep(5)">Devam Et <i class="bi bi-arrow-right ms-1"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4 step-content" id="step5" style="display: @(initialStep == 5 ? "block" : "none");">
                        <div class="card-body p-4">
                            <h4 class="mb-4">Önizleme ve Onay</h4>
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="bi bi-robot me-3 fs-4"></i>
                                <div><strong>AI Analizi</strong><br><small>İlanınız yayınlanmadan önce AI tarafından analiz edilecektir.</small></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" onclick="goToStep(4)"><i class="bi bi-arrow-left me-1"></i> Geri</button>
                                <button type="submit" class="btn btn-cta btn-lg"><i class="bi bi-check-lg me-2"></i>İlanı Yayınla</button>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="modal fade" id="successModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content text-center p-4">
                            <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex p-4 mx-auto mb-3">
                                <i class="bi bi-check-circle-fill text-success" style="font-size:3rem;"></i>
                            </div>
                            <h4>İlanınız Gönderildi!</h4>
                            <p class="text-muted">AI analizi ve moderatör onayından sonra yayınlanacaktır.</p>
                            <a asp-area="Member" asp-controller="Dashboard" asp-action="Index" class="btn btn-primary mt-2"><i class="bi bi-grid me-2"></i>İlanlarıma Git</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentStep = @initialStep, map = null, marker = null;
        function goToStep(step) {
            document.getElementById('step' + currentStep).style.display = 'none';
            document.getElementById('step' + step).style.display = 'block';
            document.querySelectorAll('.wizard-step').forEach((el, i) => {
                el.classList.remove('active', 'completed');
                if (i + 1 < step) { el.classList.add('completed'); el.querySelector('.step-number').innerHTML = '<i class="bi bi-check"></i>'; }
                else if (i + 1 === step) { el.classList.add('active'); el.querySelector('.step-number').textContent = step; }
                else el.querySelector('.step-number').textContent = i + 1;
            });
            currentStep = step;
            if (step === 4 && !map) {
                setTimeout(() => {
                    const decimalSep = '@System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator';
                    const formatCoord = (val) => val.toFixed(6).replace('.', decimalSep);
                    
                    const modelLat = @(Model.Enlem?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "null");
                    const modelLng = @(Model.Boylam?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "null");
                    const defaultLat = 35.185;
                    const defaultLng = 33.382;
                    
                    const initLat = modelLat ?? defaultLat;
                    const initLng = modelLng ?? defaultLng;
                    
                    map = L.map('locationMap').setView([initLat, initLng], 10);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    
                    marker = L.marker([initLat, initLng], { draggable: true }).addTo(map);
                    
                    if (modelLat !== null && modelLng !== null) {
                        document.getElementById('enlemInput').value = formatCoord(initLat);
                        document.getElementById('boylamInput').value = formatCoord(initLng);
                    }
                    
                    map.on('click', function(e) {
                        marker.setLatLng(e.latlng);
                        document.getElementById('enlemInput').value = formatCoord(e.latlng.lat);
                        document.getElementById('boylamInput').value = formatCoord(e.latlng.lng);
                    });
                    
                    marker.on('dragend', function(e) {
                        const pos = marker.getLatLng();
                        document.getElementById('enlemInput').value = formatCoord(pos.lat);
                        document.getElementById('boylamInput').value = formatCoord(pos.lng);
                    });
                    
                    document.getElementById('findMyLocationBtn').addEventListener('click', function() {
                        if (!navigator.geolocation) {
                            alert('Tarayıcınız konum özelliğini desteklemiyor.');
                            return;
                        }
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                map.setView([lat, lng], 13);
                                marker.setLatLng([lat, lng]);
                                document.getElementById('enlemInput').value = formatCoord(lat);
                                document.getElementById('boylamInput').value = formatCoord(lng);
                            },
                            function(error) {
                                alert('Konum alınamadı. Lütfen konum iznini kontrol edin.');
                            },
                            { enableHighAccuracy: true, timeout: 8000 }
                        );
                    });
                }, 100);
            }
        }
        function selectCategory(el) {
            document.querySelectorAll('.category-card').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            const select = document.getElementById('kategoriSelect');
            select.value = el.dataset.value || '';
            select.dispatchEvent(new Event('change'));
        }

        const VeriTipi = {
            Metin: @((int)VeriTipi.Metin),
            TamSayi: @((int)VeriTipi.TamSayi),
            Ondalik: @((int)VeriTipi.Ondalik),
            DogruYanlis: @((int)VeriTipi.DogruYanlis),
            Tarih: @((int)VeriTipi.Tarih),
            TekSecim: @((int)VeriTipi.TekSecim)
        };

        document.getElementById('kategoriSelect').addEventListener('change', async function () {
            const kategoriId = this.value;
            const container = document.getElementById('dynamicAttributesContainer');
            const fieldsDiv = document.getElementById('attributeFields');

            if (!kategoriId) {
                container.style.display = 'none';
                fieldsDiv.innerHTML = '';
                return;
            }

            const response = await fetch(`/Member/MyListings/GetAttributesForCategory?kategoriId=${kategoriId}`);
            const attributes = await response.json();

            if (attributes.length === 0) {
                container.style.display = 'none';
                fieldsDiv.innerHTML = '';
                return;
            }

            container.style.display = 'block';
            fieldsDiv.innerHTML = '';

            attributes.forEach((attr, index) => {
                const fieldHtml = createAttributeField(attr, index);
                fieldsDiv.insertAdjacentHTML('beforeend', fieldHtml);
            });
        });
        if (document.getElementById('kategoriSelect').value) {
            document.getElementById('kategoriSelect').dispatchEvent(new Event('change'));
        }

        function createAttributeField(attr, index) {
            const required = attr.zorunluMu ? ' *' : '';
            const requiredAttr = attr.zorunluMu ? 'required' : '';
            let inputHtml = '';

            switch (attr.veriTipi) {
                case VeriTipi.Metin:
                    inputHtml = `<input type="text" name="Attributes[${index}].Value" class="form-control" ${requiredAttr} />`;
                    break;
                case VeriTipi.TamSayi:
                    inputHtml = `<input type="number" name="Attributes[${index}].Value" class="form-control" ${requiredAttr} />`;
                    break;
                case VeriTipi.Ondalik:
                    inputHtml = `<input type="number" step="0.01" name="Attributes[${index}].Value" class="form-control" ${requiredAttr} />`;
                    break;
                case VeriTipi.DogruYanlis:
                    inputHtml = `
                        <div class="form-check">
                            <input type="checkbox" name="Attributes[${index}].Value" value="true" class="form-check-input" />
                            <label class="form-check-label">Evet</label>
                        </div>`;
                    break;
                case VeriTipi.Tarih:
                    inputHtml = `<input type="date" name="Attributes[${index}].Value" class="form-control" ${requiredAttr} />`;
                    break;
                case VeriTipi.TekSecim:
                    const options = attr.secenekler.map(s => `<option value="${s.id}">${s.deger}</option>`).join('');
                    inputHtml = `<select name="Attributes[${index}].Value" class="form-select" ${requiredAttr}><option value="">-- Seçin --</option>${options}</select>`;
                    break;
                default:
                    inputHtml = `<input type="text" name="Attributes[${index}].Value" class="form-control" />`;
            }

            return `
                <div class="col-md-4">
                    <input type="hidden" name="Attributes[${index}].KategoriAlaniId" value="${attr.id}" />
                    <label class="form-label">${attr.ad}${required}</label>
                    ${inputHtml}
                </div>
            `;
        }

        document.getElementById('photoInput').addEventListener('change', function () {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            Array.from(this.files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const col = document.createElement('div');
                        col.className = 'col-4 col-md-3';
                        col.innerHTML = `
                            <div class="position-relative">
                                <img src="${e.target.result}" class="img-fluid rounded" style="height:80px;width:100%;object-fit:cover;">
                                ${index === 0 ? '<span class="badge bg-primary position-absolute top-0 start-0 m-1" style="font-size:0.65rem;">Kapak</span>' : ''}
                            </div>
                        `;
                        preview.appendChild(col);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
    </script>
}
