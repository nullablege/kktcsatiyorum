@model KKTCSatiyorum.Areas.Member.Models.CreateIlanViewModel

@{
    ViewData["Title"] = "Yeni İlan Oluştur";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Yeni İlan Oluştur</h4>
                </div>
                <div class="card-body">
                    @if (TempData["ErrorMessage"] is string err)
                    {
                        <div class="alert alert-danger">@err</div>
                    }

                    <form asp-action="Create" method="post" enctype="multipart/form-data" novalidate>
                        @Html.AntiForgeryToken()
                        
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-3"></div>

                        <!-- Kategori -->
                        <div class="mb-3">
                            <label asp-for="KategoriId" class="form-label fw-bold">Kategori *</label>
                            <select asp-for="KategoriId" asp-items="Model.KategoriOptions" class="form-select" id="kategoriSelect"></select>
                            <span asp-validation-for="KategoriId" class="text-danger"></span>
                        </div>

                        <!-- Temel Alanlar -->
                        <div class="mb-3">
                            <label asp-for="Baslik" class="form-label fw-bold">İlan Başlığı *</label>
                            <input asp-for="Baslik" class="form-control" placeholder="Örn: Satılık iPhone 15 Pro" />
                            <span asp-validation-for="Baslik" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Aciklama" class="form-label fw-bold">Açıklama *</label>
                            <textarea asp-for="Aciklama" class="form-control" rows="5" placeholder="Ürününüzü detaylı olarak tanıtın..."></textarea>
                            <span asp-validation-for="Aciklama" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Fiyat" class="form-label fw-bold">Fiyat *</label>
                                <input asp-for="Fiyat" type="number" step="0.01" min="0" class="form-control" />
                                <span asp-validation-for="Fiyat" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="ParaBirimi" class="form-label fw-bold">Para Birimi</label>
                                <select asp-for="ParaBirimi" asp-items="Model.ParaBirimiOptions" class="form-select"></select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Sehir" class="form-label fw-bold">Şehir *</label>
                            <input asp-for="Sehir" class="form-control" placeholder="Örn: Lefkoşa" />
                            <span asp-validation-for="Sehir" class="text-danger"></span>
                        </div>

                        <!-- Dinamik EAV Alanları -->
                        <div id="dynamicAttributesContainer" class="mb-4" style="display:none;">
                            <hr />
                            <h5 class="mb-3"><i class="bi bi-list-ul me-2"></i>Kategori Özellikleri</h5>
                            <div id="attributeFields"></div>
                        </div>

                        <!-- Fotoğraflar -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Fotoğraflar * (İlk fotoğraf kapak olacaktır)</label>
                            <input type="file" name="photos" class="form-control" multiple accept="image/*" id="photoInput" />
                            <small class="text-muted">PNG, JPG, WEBP formatında, max 5MB</small>
                            <span class="text-danger" id="photoError"></span>
                            <div id="photoPreview" class="row mt-3"></div>
                        </div>

                        <hr />
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-lg me-1"></i> İlanı Oluştur
                            </button>
                            <a asp-action="Index" class="btn btn-outline-secondary btn-lg">İptal</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // VeriTipi enum values - Razor generated
        const VeriTipi = {
            Metin: @((int)VeriTipi.Metin),
            TamSayi: @((int)VeriTipi.TamSayi),
            Ondalik: @((int)VeriTipi.Ondalik),
            DogruYanlis: @((int)VeriTipi.DogruYanlis),
            Tarih: @((int)VeriTipi.Tarih),
            TekSecim: @((int)VeriTipi.TekSecim)
        };

        document.getElementById('kategoriSelect').addEventListener('change', async function() {
            const kategoriId = this.value;
            const container = document.getElementById('dynamicAttributesContainer');
            const fieldsDiv = document.getElementById('attributeFields');
            
            if (!kategoriId) {
                container.style.display = 'none';
                fieldsDiv.innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`/Member/MyListings/GetAttributesForCategory?kategoriId=${kategoriId}`);
                const attributes = await response.json();
                
                if (attributes.length === 0) {
                    container.style.display = 'none';
                    fieldsDiv.innerHTML = '';
                    return;
                }

                container.style.display = 'block';
                fieldsDiv.innerHTML = '';

                attributes.forEach((attr, index) => {
                    const fieldHtml = createAttributeField(attr, index);
                    fieldsDiv.insertAdjacentHTML('beforeend', fieldHtml);
                });
            } catch (error) {
                console.error('Error loading attributes:', error);
            }
        });

        function createAttributeField(attr, index) {
            const required = attr.zorunluMu ? ' *' : '';
            const requiredAttr = attr.zorunluMu ? 'required' : '';
            let inputHtml = '';

            switch (attr.veriTipi) {
                case VeriTipi.Metin:
                    inputHtml = `<input type="text" name="Attributes[${index}].Value" class="form-control" ${requiredAttr} />`;
                    break;
                case VeriTipi.TamSayi:
                    inputHtml = `<input type="number" name="Attributes[${index}].Value" class="form-control" ${requiredAttr} />`;
                    break;
                case VeriTipi.Ondalik:
                    inputHtml = `<input type="number" step="0.01" name="Attributes[${index}].Value" class="form-control" ${requiredAttr} />`;
                    break;
                case VeriTipi.DogruYanlis:
                    inputHtml = `
                        <div class="form-check">
                            <input type="checkbox" name="Attributes[${index}].Value" value="true" class="form-check-input" />
                            <label class="form-check-label">Evet</label>
                        </div>`;
                    break;
                case VeriTipi.Tarih:
                    inputHtml = `<input type="date" name="Attributes[${index}].Value" class="form-control" ${requiredAttr} />`;
                    break;
                case VeriTipi.TekSecim:
                    const options = attr.secenekler.map(s => `<option value="${s.id}">${s.deger}</option>`).join('');
                    inputHtml = `<select name="Attributes[${index}].Value" class="form-select" ${requiredAttr}><option value="">-- Seçin --</option>${options}</select>`;
                    break;
                default:
                    inputHtml = `<input type="text" name="Attributes[${index}].Value" class="form-control" />`;
            }

            return `
                <div class="mb-3">
                    <input type="hidden" name="Attributes[${index}].KategoriAlaniId" value="${attr.id}" />
                    <label class="form-label">${attr.ad}${required}</label>
                    ${inputHtml}
                </div>
            `;
        }

        // Fotoğraf önizleme
        document.getElementById('photoInput').addEventListener('change', function() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            
            Array.from(this.files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const col = document.createElement('div');
                        col.className = 'col-4 col-md-3 mb-2';
                        col.innerHTML = `
                            <div class="position-relative">
                                <img src="${e.target.result}" class="img-thumbnail" style="width:100%;height:100px;object-fit:cover;" />
                                ${index === 0 ? '<span class="badge bg-primary position-absolute top-0 start-0">Kapak</span>' : ''}
                            </div>
                        `;
                        preview.appendChild(col);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
    </script>
}
